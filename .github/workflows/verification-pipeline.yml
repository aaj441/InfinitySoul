name: Verification Debt Prevention Pipeline

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]
  schedule:
    # Run debt analysis daily at 2 AM
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18.x'

jobs:
  # Stage 1: Code Quality
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint:check
        continue-on-error: false

      - name: Check code formatting
        run: npm run format:check

      - name: TypeScript type checking
        run: npm run type-check

      - name: Check for console logs
        run: |
          if git grep -n 'console\.log' -- '*.ts' '*.tsx' '*.js' '*.jsx' ':!node_modules' ':!dist' ':!build'; then
            echo "Error: console.log statements found"
            exit 1
          fi

  # Stage 2: Testing
  testing:
    name: Automated Testing
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit -- --coverage

      - name: Run integration tests
        run: npm run test:integration
        if: always()

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella

      - name: Check coverage threshold
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          THRESHOLD=80
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "Coverage $COVERAGE% is below threshold $THRESHOLD%"
            exit 1
          fi

  # Stage 3: Security Audit
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Run dependency check
        run: npx audit-ci --high
        continue-on-error: true

  # Stage 4: WCAG Compliance
  wcag-validation:
    name: WCAG Compliance Check
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run WCAG validation
        run: npm run wcag:validate
        continue-on-error: true

      - name: Upload WCAG report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: wcag-report
          path: .verification/reports/wcag-*.json

  # Stage 5: Technical Debt Analysis
  debt-analysis:
    name: Technical Debt Analysis
    runs-on: ubuntu-latest
    needs: [testing, security]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run debt analyzer
        run: node .verification/scripts/debt-analyzer.js
        continue-on-error: true

      - name: Upload debt report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: debt-analysis-report
          path: .verification/reports/debt-*.json

      - name: Comment PR with debt analysis
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reports = fs.readdirSync('.verification/reports')
              .filter(f => f.startsWith('debt-'))
              .sort()
              .reverse();
            
            if (reports.length > 0) {
              const report = JSON.parse(fs.readFileSync(`.verification/reports/${reports[0]}`, 'utf-8'));
              
              const body = `## Technical Debt Analysis
              
              **Total Debt Items:** ${report.summary.totalDebtItems}
              **Estimated Hours:** ${report.summary.estimatedHours}
              **Debt Ratio:** ${report.summary.debtRatio} hours/KLOC
              
              ### Breakdown
              - Critical: ${report.breakdown.critical}
              - High: ${report.breakdown.high}
              - Medium: ${report.breakdown.medium}
              - Low: ${report.breakdown.low}
              
              ${report.recommendations.length > 0 ? '### Recommendations\n' + report.recommendations.map(r => `- [${r.priority.toUpperCase()}] ${r.action}`).join('\n') : ''}
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }

  # Stage 6: Quality Gates
  quality-gates:
    name: Quality Gate Enforcement
    runs-on: ubuntu-latest
    needs: [testing, security, wcag-validation]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Enforce quality gates
        run: node .verification/scripts/quality-gate.js

      - name: Upload quality gate report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: quality-gate-report
          path: .verification/reports/quality-gate-*.json

  # Stage 7: Performance Testing
  performance:
    name: Performance Testing
    runs-on: ubuntu-latest
    needs: testing
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun || echo "Lighthouse CI not configured"
        continue-on-error: true

  # Stage 8: Deployment Readiness
  deployment-readiness:
    name: Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [quality-gates, performance]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify environment variables
        run: |
          echo "Checking required environment variables..."
          # Add your required env var checks here

      - name: Verify deployment configuration
        run: |
          echo "Verifying deployment configs..."
          test -f Dockerfile || echo "Warning: No Dockerfile found"
          test -f railway.json || echo "Warning: No railway.json found"

      - name: Create deployment report
        run: |
          echo "# Deployment Readiness Report" > deployment-report.md
          echo "" >> deployment-report.md
          echo "All quality gates passed. Ready for deployment." >> deployment-report.md

      - name: Upload deployment report
        uses: actions/upload-artifact@v3
        with:
          name: deployment-report
          path: deployment-report.md

  # Notification on failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [code-quality, testing, security, quality-gates]
    if: failure()
    
    steps:
      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "Verification Pipeline Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":x: *Verification Pipeline Failed*\nRepository: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Details"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }