// InfinitySol Database Schema
// Generated by consolidation script

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CONSULTANT SITE MODELS
// ============================================================================

model ConsultantSite {
  id              String   @id @default(uuid())
  subdomain       String   @unique
  consultantEmail String
  brandName       String
  customLogo      String?
  customColors    Json?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("consultant_sites")
}

// ============================================================================
// EVIDENCE VAULT MODELS
// ============================================================================

model EvidenceFile {
  id          String   @id @default(uuid())
  type        String   // 'scan_report', 'vpat', 'certificate', 'screenshot'
  filePath    String   // S3 path
  fileName    String
  fileSize    Int?
  mimeType    String?
  customerId  String
  uploadedBy  String?
  uploadedAt  DateTime @default(now())

  metadata    Json?    // Additional file metadata

  @@map("evidence_files")
  @@index([customerId])
  @@index([type])
}

// ============================================================================
// AUTOMATION MODELS
// ============================================================================

model AutomationJob {
  id          String   @id @default(uuid())
  type        String   // 'email', 'vpat', 'lead_import'
  status      String   @default("pending") // 'pending', 'processing', 'completed', 'failed'
  payload     Json     // Job-specific data
  result      Json?    // Job results
  error       String?  // Error message if failed
  retryCount  Int      @default(0)
  maxRetries  Int      @default(3)
  createdAt   DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  @@map("automation_jobs")
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// SCAN RESULTS (Enhanced)
// ============================================================================

model ScanResult {
  id                    String   @id @default(uuid())
  url                   String
  auditId               String   @unique
  status                String   // 'success', 'failed'

  // Violation counts
  criticalCount         Int      @default(0)
  seriousCount          Int      @default(0)
  moderateCount         Int      @default(0)
  minorCount            Int      @default(0)
  totalCount            Int      @default(0)

  // Risk analysis
  riskScore             Float?
  estimatedLawsuitCost  Float?
  industry              String?

  // Raw data
  violationsData        Json?    // Full axe-core results

  // Metadata
  scannedAt             DateTime @default(now())
  email                 String?

  @@map("scan_results")
  @@index([url])
  @@index([scannedAt])
  @@index([email])
}

// ============================================================================
// LEADS (For tracking potential customers)
// ============================================================================

model Lead {
  id            String   @id @default(uuid())
  email         String   @unique
  companyName   String?
  website       String?
  industry      String?

  // Lead source
  source        String?  // 'scan', 'insurance_api', 'manual'

  // Engagement
  lastContactAt DateTime?
  status        String   @default("new") // 'new', 'contacted', 'qualified', 'customer', 'lost'

  // Metadata
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("leads")
  @@index([email])
  @@index([status])
}

// ============================================================================
// PHASE III — RISK UNDERWRITING ENGINE
// ============================================================================

// Compliance Credit Score (CCS v2.0) - Like FICO but for ADA/WCAG
model ComplianceScore {
  id                    String   @id @default(uuid())
  scanResultId          String   @unique

  // The score (0-850)
  score                 Int      // 0-850 scale
  grade                 String   // 'A+', 'A', 'B', 'C', 'D', 'F'

  // Score components
  technicalDebtScore    Float    // 0-100, impact of violations
  jurisdictionRisk      Float    // 0-100, legal risk by jurisdiction
  serialPlaintiffRisk   Float    // 0-100, threat from serial plaintiffs
  improvementTrend      Float    // 0-100, velocity of fixes
  industryAdjustment    Float    // 0-100, compared to industry peers

  // Scoring breakdown
  violationCount        Int      // Total violations
  criticalViolations    Int      // WCAG AA failures
  seriousViolations     Int      // WCAG A failures

  // Risk factors
  publicLawsuitCount    Int      @default(0)  // Historical lawsuits
  serialPlaintiffScore  Float    @default(0)  // Risk from known plaintiffs
  cmsRisk               Float    @default(0)  // Platform (WordPress, etc) risk
  trafficMagnitude      Int      @default(0)  // Monthly visitors
  revenuePerVisitor     Float    @default(0)  // Annual revenue / traffic

  // Historical tracking
  previousScore         Int?     // Score from 30 days ago
  trendDirection        String   @default("stable") // 'improving', 'worsening', 'stable'

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("compliance_scores")
  @@index([score])
  @@index([createdAt])
}

// Multi-engine accessibility scan with consensus
model AccessibilityScanConsensus {
  id                    String   @id @default(uuid())
  scanResultId          String   @unique

  // Scan details
  url                   String
  domain                String
  scanDate              DateTime @default(now())

  // Engine results (stored as JSON for flexibility)
  axeResults            Json?    // axe-core results
  pa11yResults          Json?    // Pa11y results
  waveResults           Json?    // WAVE API results
  lighthouseResults     Json?    // Lighthouse accessibility results

  // Consensus violations
  consensusViolations   Json     // Violations agreed upon by 2+ engines
  criticalConsensus     Int      @default(0)
  majorConsensus        Int      @default(0)
  minorConsensus        Int      @default(0)

  // Confidence scores
  avgConfidence         Float    // Average engine confidence

  // Execution details
  executionTimeMs       Int?     // Time to run all engines
  allEnginesSuccessful  Boolean  @default(false)

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("accessibility_scan_consensus")
  @@index([domain])
  @@index([scanDate])
}

// Insurance-grade risk assessment
model RiskAssessment {
  id                        String   @id @default(uuid())
  scanResultId              String   @unique
  complianceScoreId         String   @unique

  // Lawsuit probability
  annualLawsuitProbability  Float    // 0.0-1.0 (0%-100%)

  // Financial exposure
  expectedLawsuitCost       Int      // Settlement + legal fees
  estimatedSettlementLow    Int
  estimatedSettlementMid    Int
  estimatedSettlementHigh   Int
  estimatedLegalFeesLow     Int
  estimatedLegalFeesHigh    Int
  totalExposureLow          Int
  totalExposureHigh         Int

  // Insurance pricing
  recommendedInsurancePremium Int   // Annual premium recommendation
  recommendedRemediationBudget Int // Cost to fix issues

  // Risk factors
  industryRiskScore         Float    // 0-1.0
  jurisdictionRiskScore     Float    // 0-1.0
  plaintiffHistoryScore     Float    // 0-1.0
  violationSeverityScore    Float    // 0-1.0

  // Comparable cases
  comparableCasesCount      Int      @default(0)
  averageSettlementAmount   Int?
  mediaExposureRisk         String?  // 'high', 'medium', 'low'

  // Assessment quality
  assessmentConfidence      Float    // 0-1.0
  lastReassessmentDate      DateTime?

  // Metadata
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@map("risk_assessments")
  @@index([annualLawsuitProbability])
  @@index([createdAt])
}

// Risk profile for continuous monitoring
model RiskProfile {
  id                    String   @id @default(uuid())

  // Domain identification
  domain                String   @unique
  url                   String

  // Organization info
  companyName           String?
  industry              String?
  estimatedTraffic      Int?     // Monthly visitors
  estimatedRevenue      Float?   // Annual revenue

  // Current risk scores
  currentCcsScore       Int?     // Latest CCS score
  currentProbability    Float?   // Current lawsuit probability
  currentExposure       Int?     // Current estimated exposure

  // Historical tracking
  scoringHistory        Json     @default("[]") // Array of { date, score, probability, exposure }
  violationTrend        String   @default("neutral") // 'improving', 'worsening', 'neutral'

  // Risk factors
  publicLawsuits        Int      @default(0)
  knownSerialPlaintiffs Boolean  @default(false)
  regulatoryFocus       Boolean  @default(false) // Under DOJ/CFPB scrutiny
  mediaAttention        Boolean  @default(false)

  // Monitoring
  monitoringEnabled     Boolean  @default(true)
  monitoringFrequency   String   @default("weekly") // 'daily', 'weekly', 'monthly'
  lastScanDate          DateTime?
  nextScheduledScan     DateTime?

  // Insurance metadata
  insurancePartner      String?
  insurancePolicy       String?
  insuranceExpiresAt    DateTime?

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("risk_profiles")
  @@index([currentCcsScore])
  @@index([domain])
  @@index([industry])
  @@index([lastScanDate])
}

// ============================================================================
// PHASE V — AUTONOMOUS ADA THREAT INTELLIGENCE NETWORK
// ============================================================================

// Real-time lawsuit tracking from PACER, CourtListener, etc.
model Lawsuit {
  id                    String   @id @default(uuid())

  // Case identifiers
  caseNumber            String   @unique
  court                 String   // Federal district, state court
  jurisdiction          String   // State abbreviation

  // Parties
  plaintiff             String
  plaintiffAttorney     String?
  defendant             String   // Domain or company
  defendantSize         String?  // 'startup', 'smb', 'mid-market', 'enterprise'

  // Case details
  violationTypes        String[] // WCAG violations alleged
  filedDate             DateTime
  status                String   // 'filed', 'settled', 'judgment', 'dismissed'
  settlementAmount      Int?
  legalFeesPaid         Int?

  // Risk signals
  industry              String?
  isSocialMedia         Boolean  @default(false)
  isRetail              Boolean  @default(false)
  isEcommerce           Boolean  @default(false)
  isHealthcare          Boolean  @default(false)
  isEducation           Boolean  @default(false)

  // Intelligence
  serialPlaintiff       Boolean  @default(false)
  aggressiveAttorney    Boolean  @default(false)
  mediaAttention        Boolean  @default(false)

  // Source & metadata
  source                String   // 'PACER', 'CourtListener', 'News'
  sourceUrl             String?
  fetchedAt             DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("lawsuits")
  @@index([defendant])
  @@index([jurisdiction])
  @@index([filedDate])
  @@index([plaintiffAttorney])
  @@index([serialPlaintiff])
}

// Serial plaintiff profile with behavioral data
model SerialPlaintiff {
  id                    String   @id @default(uuid())

  // Profile
  name                  String   @unique
  lawFirm               String?
  attorneyNames         String[]

  // Activity metrics
  totalFilings          Int      @default(0)
  settlementsWon        Int      @default(0)
  winRate               Float    @default(0.0) // 0-1.0
  averageSettlement     Int?     // Average settlement amount

  // Targeting patterns
  preferredJurisdictions String[]
  preferredIndustries   String[]
  targetCompanySizes    String[] // 'startup', 'smb', etc.
  targetCMS             String[] // 'WordPress', 'Shopify', etc.

  // Behavior signals
  filingVelocity        Int      @default(0) // Lawsuits per month
  jurisdictionExpansion Boolean  @default(false)
  partnershipChanges    Boolean  @default(false)

  // Threat level
  threatLevel           String   @default("medium") // 'critical', 'high', 'medium', 'low'
  lastActivityDate      DateTime?
  nextPredictedTarget   String?  // Domain or company name

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("serial_plaintiffs")
  @@index([name])
  @@index([threatLevel])
  @@index([preferredIndustries])
}

// Industry-wide litigation heatmap
model IndustryLitigationRisk {
  id                    String   @id @default(uuid())

  // Industry info
  industry              String   @unique // e.g., 'retail', 'ecommerce', 'saas'

  // Risk metrics
  litigationDensity     Float    // Lawsuits per 10K companies per year
  recentFilingCount     Int      // Lawsuits in past 90 days
  totalFilingsThisYear  Int

  // Trends
  trend                 String   @default("stable") // 'rising', 'falling', 'stable'
  trendDirection        Int      @default(0) // -1 = falling, 0 = stable, +1 = rising

  // Threat intelligence
  dominantPlaintiffs    String[] // Top 3 serial plaintiffs
  commonViolations      String[] // Most-sued violations
  averageSettlement     Int?

  // Predictive signals
  forecasted30DayFilings Int?
  forecasted90DayFilings Int?

  // Metadata
  lastUpdated           DateTime @default(now())
  dataSource            String   // 'PACER', 'aggregated'

  @@map("industry_litigation_risk")
  @@index([industry])
  @@index([trend])
  @@index([litigationDensity])
}

// Jurisdiction-level threat assessment
model JurisdictionThreat {
  id                    String   @id @default(uuid())

  // Location
  state                 String   @unique // CA, NY, FL, etc.
  federalCircuit        String?

  // Litigation metrics
  annualLawsuitCount    Int      @default(0)
  activeSerialPlaintiffs Int     @default(0)
  averageSettlement     Int?
  plaintiff wins         Float    @default(0.5) // 0-1.0

  // Risk assessment
  threatLevel           String   @default("medium") // 'critical', 'high', 'medium', 'low'
  heating                Boolean  @default(false) // Is litigation rising?
  litigationTrend       String   @default("stable") // 'rising', 'falling', 'stable'

  // Trend data
  litigationVelocity    Int      @default(0) // New lawsuits per month
  recent30DayFilings    Int      @default(0)
  recent90DayFilings    Int      @default(0)

  // Plaintiff activity
  activePlaintiffNames  String[]
  aggressiveLawFirms    String[]

  // Metadata
  lastUpdated           DateTime @default(now())
  flaggedForEscalation  Boolean  @default(false)

  @@map("jurisdiction_threats")
  @@index([state])
  @@index([threatLevel])
  @@index([heating])
}

// Lawsuit prediction model outputs
model LawsuitPrediction {
  id                    String   @id @default(uuid())

  // Target
  domain                String
  companyName           String?
  industry              String?
  jurisdiction          String?

  // Probability predictions
  probability30Days     Float    // 0.0-1.0
  probability90Days     Float
  probability1Year      Float

  // Feature importance (what drives the prediction)
  violationTrendScore   Float
  industryRiskScore     Float
  jurisdictionRiskScore Float
  plaintiffProximityScore Float
  cmsRiskScore          Float

  // Prediction metadata
  confidence            Float    // 0.0-1.0
  riskRating            String   // 'critical', 'high', 'medium', 'low'
  predictedPlaintiffs   String[] // Top 3 likely plaintiffs
  predictedSettlement   Int?     // Estimated if sued

  // Model version
  modelVersion          String   @default("v3.0")
  predictedAt           DateTime @default(now())
  nextUpdateAt          DateTime?

  @@map("lawsuit_predictions")
  @@index([domain])
  @@index([probability30Days])
  @@index([riskRating])
  @@index([predictedAt])
}

// Portfolio-level risk aggregation for insurers/law firms
model PortfolioRiskAssessment {
  id                    String   @id @default(uuid())

  // Portfolio info
  portfolioName         String
  ownerType             String   // 'law_firm', 'insurer', 'agency'
  ownerName             String?
  clientCount           Int      @default(0)

  // Aggregate metrics
  totalExposure         Int      // Sum of all client exposures
  expectedClaimsPerYear Float
  averageComplianceScore Int?
  averageLitigationProbability Float?

  // Risk distribution
  criticalRiskCount     Int      @default(0) // Clients in critical risk
  highRiskCount         Int      @default(0)
  mediumRiskCount       Int      @default(0)
  lowRiskCount          Int      @default(0)

  // Clustered risks
  litigationClusterRisk Boolean  @default(false) // Multiple clients at risk
  jurisdictionHotspots  String[]
  industryHotspots      String[]

  // Insurer-relevant metrics
  estimatedTotalClaims  Int?
  recommendedPremium    Int?
  lossReductionOpportunity Int?

  // Remediation priorities
  urgentRemediationCount Int      @default(0) // Clients needing immediate fixes

  // Metadata
  lastUpdated           DateTime @default(now())
  nextAssessment        DateTime?

  @@map("portfolio_risk_assessments")
  @@index([ownerType])
  @@index([totalExposure])
  @@index([litigationClusterRisk])
}

// Global threat intelligence pulse
model ThreatIntelligencePulse {
  id                    String   @id @default(uuid())

  // Global metrics
  globalRiskIndex       Int      // 0-100 scale
  litigationActivityLevel String  // 'surging', 'elevated', 'normal', 'quiet'
  serialPlaintiffActivityLevel String

  // Industry breakdown
  industryRiskSnapshot  Json     // { industry: threatLevel }
  jurisdictionRiskSnapshot Json   // { state: threatLevel }

  // Alerts
  activeAlerts          Int      @default(0)
  emergingThreats       String[] // Industries/jurisdictions to watch
  riskTrends            String[] // 'retail-surge', 'saas-stable', etc.

  // Predictions
  forecast30Days        Int?     // Predicted lawsuits in next 30 days
  forecast90Days        Int?

  // Metadata
  pulseTime             DateTime @default(now())
  dataQuality           Float    // 0.0-1.0
  sourceCount           Int      // Number of data sources aggregated

  @@map("threat_intelligence_pulses")
  @@index([pulseTime])
  @@index([globalRiskIndex])
}
