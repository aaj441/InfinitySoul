// InfinitySol Database Schema
// Generated by consolidation script

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CONSULTANT SITE MODELS
// ============================================================================

model ConsultantSite {
  id              String   @id @default(uuid())
  subdomain       String   @unique
  consultantEmail String
  brandName       String
  customLogo      String?
  customColors    Json?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("consultant_sites")
}

// ============================================================================
// EVIDENCE VAULT MODELS
// ============================================================================

model EvidenceFile {
  id          String   @id @default(uuid())
  type        String   // 'scan_report', 'vpat', 'certificate', 'screenshot'
  filePath    String   // S3 path
  fileName    String
  fileSize    Int?
  mimeType    String?
  customerId  String
  uploadedBy  String?
  uploadedAt  DateTime @default(now())

  metadata    Json?    // Additional file metadata

  @@map("evidence_files")
  @@index([customerId])
  @@index([type])
}

// ============================================================================
// AUTOMATION MODELS
// ============================================================================

model AutomationJob {
  id          String   @id @default(uuid())
  type        String   // 'email', 'vpat', 'lead_import'
  status      String   @default("pending") // 'pending', 'processing', 'completed', 'failed'
  payload     Json     // Job-specific data
  result      Json?    // Job results
  error       String?  // Error message if failed
  retryCount  Int      @default(0)
  maxRetries  Int      @default(3)
  createdAt   DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  @@map("automation_jobs")
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// SCAN RESULTS (Enhanced)
// ============================================================================

model ScanResult {
  id                    String   @id @default(uuid())
  url                   String
  auditId               String   @unique
  status                String   // 'success', 'failed'

  // Violation counts
  criticalCount         Int      @default(0)
  seriousCount          Int      @default(0)
  moderateCount         Int      @default(0)
  minorCount            Int      @default(0)
  totalCount            Int      @default(0)

  // Risk analysis
  riskScore             Float?
  estimatedLawsuitCost  Float?
  industry              String?

  // Raw data
  violationsData        Json?    // Full axe-core results

  // Metadata
  scannedAt             DateTime @default(now())
  email                 String?

  @@map("scan_results")
  @@index([url])
  @@index([scannedAt])
  @@index([email])
}

// ============================================================================
// LEADS (For tracking potential customers)
// ============================================================================

model Lead {
  id            String   @id @default(uuid())
  email         String   @unique
  companyName   String?
  website       String?
  industry      String?

  // Lead source
  source        String?  // 'scan', 'insurance_api', 'manual'

  // Engagement
  lastContactAt DateTime?
  status        String   @default("new") // 'new', 'contacted', 'qualified', 'customer', 'lost'

  // Metadata
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("leads")
  @@index([email])
  @@index([status])
}
